<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forgemaster Calculator — DPS Builder</title>
  <style>
    :root{--max-width:980px;--gap:12px}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:2rem;background:#f7fafc;color:#0f172a}
    .wrap{max-width:var(--max-width);margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
    h1{font-size:1.25rem;margin:0}
    .card{background:#fff;border:1px solid #e6edf3;border-radius:8px;padding:1rem;margin-bottom:1rem}
    .slots{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:var(--gap)}
    .slot{border:1px dashed #e2e8f0;padding:.75rem;border-radius:6px}
    .row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}
    label{font-size:.85rem;color:#374151;width:110px}
    input[type=number],select{flex:1;padding:.4rem;border:1px solid #cbd5e1;border-radius:4px}
    .small{width:80px}
    #total-hp,#total-dmg,#dps,#hp-regen{width:180px!important}
    .controls{display:flex;gap:.5rem;flex-wrap:wrap}
    .summary{white-space:pre-wrap;font-family:monospace;background:#0f172a;color:#f8fafc;padding:.75rem;border-radius:6px;max-height:220px;overflow:auto}
    button{background:#0ea5a4;color:#fff;border:none;padding:.5rem .75rem;border-radius:6px;cursor:pointer}
    button:disabled{opacity:.6;cursor:default}
    footer{margin-top:1rem;font-size:.85rem;color:#475569}
    @media (max-width:520px){label{width:95px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Forgemaster Calculator — DPS Builder</h1>
      <div style="display:flex;gap:.75rem;align-items:center">
        <div>Slots: <strong id="slot-count">8</strong></div>
        <div id="store-status" style="font-size:.85rem;color:#64748b">No stored data</div>
      </div>
    </header>

    <div class="card">
      <h2 style="margin-top:0">Equipment Slots</h2>
      <p style="margin:0 0 .5rem">Enter base Health and Damage per slot, choose two substats and enter their values.</p>

      <form id="dps-form">
        <div id="slots" class="slots"></div>

        <div style="margin-top:1rem;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
          <button id="store" type="button">Store</button>
          <button id="save" type="button">Save (local)</button>
          <button id="load" type="button">Load (local)</button>
          <button id="reset" type="button">Reset</button>
          <button id="export" type="button">Export JSON</button>
          <input id="import-file" type="file" accept="application/json" style="display:none" />
          <button id="import" type="button">Import JSON</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2 style="margin-top:0">Summary</h2>
      <div class="row" style="margin-bottom:.75rem"><label>Total HP</label><input id="total-hp" class="small" readonly><label style="width:120px">Total Damage</label><input id="total-dmg" class="small" readonly></div>
      <div class="row" style="margin-bottom:.75rem"><label>DPS</label><input id="dps" class="small" readonly><label style="width:120px">HP Regen</label><input id="hp-regen" class="small" readonly></div>
      <h3 style="margin:.5rem 0 .25rem">Substats</h3>
      <div id="substats-list" style="display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.75rem;color:#0f172a"></div>
      <h3 style="margin:.5rem 0 .25rem">Current Data (JSON)</h3>
      <div id="preview" class="summary">{ }</div>
    </div>

    <footer>
      <small>Built for prototyping — you can customize substat options and calculations later.</small>
    </footer>
  </div>

  <script>
    const SUBSTAT_OPTIONS = [
      {v:'none', t:'None'},
      {v:'atk_speed', t:'Attack Speed'},
      {v:'blk_rate', t:'Block'},
      {v:'crit_rate', t:'Crit Rate'},
      {v:'crit_dmg', t:'Crit Damage'},
      {v:'dmg', t:'Damage'},
      {v:'double_rate', t:'Double chance'},
      {v:'hp_regen', t:'Health regen'},
      {v:'health', t:'Health'},
      {v:'life_steal', t:'Life steal'},
      {v:'melee_dmg', t:'Melee Damage'},
      {v:'ranged_dmg', t:'Ranged Damage'},
      {v:'skill_cd', t:'Skill CD Reduction'},
      {v:'skill_dmg', t:'Skill Damage'}
    ];

    // Define slot names here (edit to customize)
    const SLOT_NAMES = ['head','chest','gloves','necklace','ring','weapon','boots','belt','mount','pet1','pet2','pet3','skill_bonus'];
    // slots with HP only
    const HEALTH_ONLY = ['head','chest','boots','belt'];
    // computed helper for damage-only slots
    const DAMAGE_ONLY = SLOT_NAMES.filter(n=>!HEALTH_ONLY.includes(n));
    // simple capitalization helper for UI
    function cap(s){ return (typeof s==='string' && s.length>0) ? (s[0].toUpperCase()+s.slice(1)) : s; }
    const SLOTS = SLOT_NAMES.length;
    const slotsContainer = document.getElementById('slots');
    const preview = document.getElementById('preview');
    const totalHpInput = document.getElementById('total-hp');
    const totalDmgInput = document.getElementById('total-dmg');

    function createSelect(name){
      const sel = document.createElement('select');
      sel.name = name;
      SUBSTAT_OPTIONS.forEach(o=>{
        const opt = document.createElement('option'); opt.value=o.v; opt.textContent=o.t; sel.appendChild(opt);
      });
      return sel;
    }

    function makeSlot(i){
      const div = document.createElement('div'); div.className='slot';
      const title = document.createElement('div'); title.style.fontWeight='600'; title.style.marginBottom='8px';
      const slotName = SLOT_NAMES[i] || ('Slot '+(i+1));
      title.textContent = cap(slotName);
      div.appendChild(title);

      // HP & DMG row — create only the relevant input(s)
      const row1 = document.createElement('div'); row1.className='row';
      const labHp = document.createElement('label'); labHp.textContent='Health';
      let inpHp = null;
      const labDmg = document.createElement('label'); labDmg.textContent='Damage'; labDmg.style.width='75px';
      let inpDmg = null;

      if(slotName === 'mount'){
        // Mount has both HP and Damage and contributes those to substats instead of totals
        inpHp = document.createElement('input'); inpHp.type='number'; inpHp.name=`slot_${i}_hp`; inpHp.min='0'; inpHp.step='1'; inpHp.className='small';
        inpDmg = document.createElement('input'); inpDmg.type='number'; inpDmg.name=`slot_${i}_dmg`; inpDmg.min='0'; inpDmg.step='1'; inpDmg.className='small';
        row1.appendChild(labHp); row1.appendChild(inpHp); row1.appendChild(labDmg); row1.appendChild(inpDmg);
      } else if(slotName === 'skill_bonus'){
        // Skill bonus has both HP and Damage and contributes to totals like normal slots, no substats
        inpHp = document.createElement('input'); inpHp.type='number'; inpHp.name=`slot_${i}_hp`; inpHp.min='0'; inpHp.step='1'; inpHp.className='small';
        inpDmg = document.createElement('input'); inpDmg.type='number'; inpDmg.name=`slot_${i}_dmg`; inpDmg.min='0'; inpDmg.step='1'; inpDmg.className='small';
        row1.appendChild(labHp); row1.appendChild(inpHp); row1.appendChild(labDmg); row1.appendChild(inpDmg);
        div.appendChild(row1);
        // attach event listeners and return early (no substats for skill_bonus)
        [inpHp, inpDmg].forEach(el=>el.addEventListener('input', ()=>{ markDirty(true); highlightDiffs(); if(storedData) renderStored(); }));
        return div;
      } else if(slotName && slotName.startsWith && slotName.startsWith('pet')){
        // Pets have both HP and Damage and contribute to totals like normal slots
        inpHp = document.createElement('input'); inpHp.type='number'; inpHp.name=`slot_${i}_hp`; inpHp.min='0'; inpHp.step='1'; inpHp.className='small';
        inpDmg = document.createElement('input'); inpDmg.type='number'; inpDmg.name=`slot_${i}_dmg`; inpDmg.min='0'; inpDmg.step='1'; inpDmg.className='small';
        row1.appendChild(labHp); row1.appendChild(inpHp); row1.appendChild(labDmg); row1.appendChild(inpDmg);
      } else if(HEALTH_ONLY.includes(slotName)){
        inpHp = document.createElement('input'); inpHp.type='number'; inpHp.name=`slot_${i}_hp`; inpHp.min='0'; inpHp.step='1'; inpHp.className='small';
        row1.appendChild(labHp); row1.appendChild(inpHp);
      } else if(DAMAGE_ONLY.includes(slotName)){
        inpDmg = document.createElement('input'); inpDmg.type='number'; inpDmg.name=`slot_${i}_dmg`; inpDmg.min='0'; inpDmg.step='1'; inpDmg.className='small';
        row1.appendChild(labDmg); row1.appendChild(inpDmg);
      } else {
        // fallback: create both
        inpHp = document.createElement('input'); inpHp.type='number'; inpHp.name=`slot_${i}_hp`; inpHp.min='0'; inpHp.step='1'; inpHp.className='small';
        inpDmg = document.createElement('input'); inpDmg.type='number'; inpDmg.name=`slot_${i}_dmg`; inpDmg.min='0'; inpDmg.step='1'; inpDmg.className='small';
        row1.appendChild(labHp); row1.appendChild(inpHp); row1.appendChild(labDmg); row1.appendChild(inpDmg);
      }

      div.appendChild(row1);

      // Substat rows
      const row2 = document.createElement('div'); row2.className='row';
      const lab1 = document.createElement('label'); lab1.textContent='Substat 1';
      const sel1 = createSelect(`slot_${i}_sub_1`);
      const val1 = document.createElement('input'); val1.type='number'; val1.name=`slot_${i}_sub_1_val`; val1.step='any'; val1.className='small';
      row2.appendChild(lab1); row2.appendChild(sel1); row2.appendChild(val1);
      div.appendChild(row2);

      const row3 = document.createElement('div'); row3.className='row';
      const lab2 = document.createElement('label'); lab2.textContent='Substat 2';
      const sel2 = createSelect(`slot_${i}_sub_2`);
      const val2 = document.createElement('input'); val2.type='number'; val2.name=`slot_${i}_sub_2_val`; val2.step='any'; val2.className='small';
      row3.appendChild(lab2); row3.appendChild(sel2); row3.appendChild(val2);
      div.appendChild(row3);

      // Event listeners (attach only to existing elements)
      [inpHp, inpDmg, sel1, sel2, val1, val2].filter(Boolean).forEach(el=>el.addEventListener('input', ()=>{ markDirty(true); highlightDiffs(); if(storedData) renderStored(); }));

      return div;
    }

    function init(){
      // update visible slot count
      const sc = document.getElementById('slot-count'); if(sc) sc.textContent = SLOTS;
      for(let i=0;i<SLOTS;i++) slotsContainer.appendChild(makeSlot(i));
      document.getElementById('store').addEventListener('click', storeData);
      document.getElementById('save').addEventListener('click', saveLocal);
      document.getElementById('load').addEventListener('click', ()=>{ loadLocal(); markDirty(true); });
      document.getElementById('reset').addEventListener('click', ()=>{ resetForm(); markDirty(true); });
      document.getElementById('export').addEventListener('click', exportJson);
      const importFile = document.getElementById('import-file');
      document.getElementById('import').addEventListener('click', ()=>importFile.click());
      importFile.addEventListener('change', (e)=>{ importJson(e); markDirty(true); });
      // do not auto-update preview on load; stored data must be set by pressing Store
      renderStored();
    }

    function readForm(){
      const data = {slots:[]};
      for(let i=0;i<SLOTS;i++){
        const hpEl = document.querySelector(`[name="slot_${i}_hp"]`);
        const dmgEl = document.querySelector(`[name="slot_${i}_dmg"]`);
        let hp = null;
        let dmg = null;
        if(hpEl){ hp = (hpEl.value === '' ? null : Number(hpEl.value)); }
        if(dmgEl){ dmg = (dmgEl.value === '' ? null : Number(dmgEl.value)); }
        const sub1 = document.querySelector(`[name=\"slot_${i}_sub_1\"]`)?.value || 'none';
        const sub1vRaw = document.querySelector(`[name=\"slot_${i}_sub_1_val\"]`)?.value;
        const sub1v = (sub1vRaw === '' || sub1vRaw === undefined) ? null : Number(sub1vRaw);
        const sub2 = document.querySelector(`[name=\"slot_${i}_sub_2\"]`)?.value || 'none';
        const sub2vRaw = document.querySelector(`[name=\"slot_${i}_sub_2_val\"]`)?.value;
        const sub2v = (sub2vRaw === '' || sub2vRaw === undefined) ? null : Number(sub2vRaw);
        const slotName = SLOT_NAMES[i];
        if(HEALTH_ONLY.includes(slotName)){
          dmg = 0;
        } else if(DAMAGE_ONLY.includes(slotName) && slotName !== 'mount' && !(slotName && slotName.startsWith && slotName.startsWith('pet')) && slotName !== 'skill_bonus'){
          // do not zero mount, pet, or skill_bonus HP — they have both inputs
          hp = 0;
        }
        data.slots.push({hp,dmg,sub1,sub1v,sub2,sub2v});
      }
      return data;
    }

    function getSubstatLabel(key){
      const found = SUBSTAT_OPTIONS.find(o=>o.v===key);
      return found ? found.t : key;
    }

    // Compute totals and derived stats from an array of slots
    function computeTotalsFromSlots(slots){
      const totals = {totalHp:0,totalDmg:0,substats:{}};
      (slots || []).forEach((s,idx)=>{
        const name = SLOT_NAMES[idx];
        if(name === 'mount'){
          if(s.hp) totals.substats['health'] = (totals.substats['health'] || 0) + s.hp;
          if(s.dmg) totals.substats['dmg'] = (totals.substats['dmg'] || 0) + s.dmg;
        } else {
          totals.totalHp += (s.hp || 0);
          totals.totalDmg += (s.dmg || 0);
        }
        if(s.sub1 && s.sub1 !== 'none') totals.substats[s.sub1] = (totals.substats[s.sub1] || 0) + (s.sub1v || 0);
        if(s.sub2 && s.sub2 !== 'none') totals.substats[s.sub2] = (totals.substats[s.sub2] || 0) + (s.sub2v || 0);
      });
      // Provisional DPS and HP Regen calculations:
      const baseDamage = (totals.totalDmg || 0) * (1+totals.substats['dmg']/100 || 0);
      const atkSpeedFactor = 1 + ((totals.substats['atk_speed'] || 0)/100);
      const baseAttacksPerSec = 0.5; // assume 0.5 attacks per second base
      const damagePercentFactor = 1 + ((totals.substats['melee_dmg'] || 0) + (totals.substats['ranged_dmg'] || 0))/100;
      const doubleFactor = 1 + ((totals.substats['double_rate'] || 0)/100);
      const critRate = Math.min(100, (totals.substats['crit_rate'] || 0))/100;
      const critDmg = 0.2 + (totals.substats['crit_dmg'] || 0)/100;
      const critFactor = 1 + (critRate * critDmg);
      const dps =  baseDamage * baseAttacksPerSec * atkSpeedFactor * damagePercentFactor * doubleFactor * critFactor;
      const hpRegen = (totals.totalHp || 0) * (totals.substats['hp_regen'] || 0) / 100 + dps * ((totals.substats['life_steal'] || 0)/100);
      totals.dps = dps;
      totals.hpRegen = hpRegen;
      totals.totalHp = totals.totalHp * (1 + (totals.substats['health'] || 0)/100);
      return totals;
    }

    function getTotals(){
      const d = readForm();
      const totals = computeTotalsFromSlots(d.slots);
      return {d,totals};
    }

    function renderSubstats(substats){
      const container = document.getElementById('substats-list');
      container.innerHTML = '';
      const entries = Object.entries(substats).filter(([k,v])=>v && v !== 0);
      if(entries.length===0){
        const none = document.createElement('div'); none.style.color='#64748b'; none.textContent = 'No substats entered'; container.appendChild(none); return;
      }
      entries.forEach(([k,v])=>{
        const el = document.createElement('div');
        el.style.background = '#eef2f6'; el.style.borderRadius='6px'; el.style.padding='6px 8px'; el.style.fontSize='.9rem';
        el.textContent = `${getSubstatLabel(k)}: ${Number(v).toFixed(2)}`;
        container.appendChild(el);
      });
    }

    // Highlighting differences between current form and stored JSON
    function setHighlight(el, on){ if(!el) return; el.style.backgroundColor = on ? '#fff7cc' : ''; }

    function highlightDiffs(){
      // clear all highlights first
      for(let i=0;i<SLOTS;i++){
        const els = [
          document.querySelector(`[name="slot_${i}_hp"]`),
          document.querySelector(`[name="slot_${i}_dmg"]`),
          document.querySelector(`[name="slot_${i}_sub_1"]`),
          document.querySelector(`[name="slot_${i}_sub_1_val"]`),
          document.querySelector(`[name="slot_${i}_sub_2"]`),
          document.querySelector(`[name="slot_${i}_sub_2_val"]`)
        ];
        els.forEach(e=>{ if(e) setHighlight(e,false); });
      }
      if(!storedData) return;
      // Helper: treat null and 0 as equivalent for numeric comparisons
      const norm = (v) => (v === null ? 0 : v);
      storedData.slots.forEach((s,i)=>{
        const slotName = SLOT_NAMES[i];
        const hpEl = document.querySelector(`[name="slot_${i}_hp"]`);
        const dmgEl = document.querySelector(`[name="slot_${i}_dmg"]`);
        if(hpEl){ const curr = (hpEl.value === '' ? null : Number(hpEl.value)); const stored = (s.hp === undefined ? null : s.hp); setHighlight(hpEl, norm(curr) !== norm(stored)); }
        if(dmgEl){ const curr = (dmgEl.value === '' ? null : Number(dmgEl.value)); const stored = (s.dmg === undefined ? null : s.dmg); setHighlight(dmgEl, norm(curr) !== norm(stored)); }
        const sel1 = document.querySelector(`[name="slot_${i}_sub_1"]`); if(sel1){ const curr = sel1.value || 'none'; const stored = s.sub1 || 'none'; setHighlight(sel1, curr !== stored); }
        const val1 = document.querySelector(`[name="slot_${i}_sub_1_val"]`); if(val1){ const raw = val1.value; const curr = (raw === '' ? null : Number(raw)); const stored = (s.sub1v === undefined ? null : s.sub1v); setHighlight(val1, norm(curr) !== norm(stored)); }
        const sel2 = document.querySelector(`[name="slot_${i}_sub_2"]`); if(sel2){ const curr = sel2.value || 'none'; const stored = s.sub2 || 'none'; setHighlight(sel2, curr !== stored); }
        const val2 = document.querySelector(`[name="slot_${i}_sub_2_val"]`); if(val2){ const raw = val2.value; const curr = (raw === '' ? null : Number(raw)); const stored = (s.sub2v === undefined ? null : s.sub2v); setHighlight(val2, norm(curr) !== norm(stored)); }
      });
    }

    // Stored data state: only updated when pressing the Store button
    let storedData = null;
    let isDirty = false;

    function setStatus(text, highlight=false){
      const el = document.getElementById('store-status'); if(!el) return;
      el.textContent = text;
      el.style.color = highlight ? '#0ea5a4' : '#64748b';
    }

    function markDirty(state=true){
      isDirty = state;
      setStatus(isDirty ? 'Unsaved changes' : (storedData ? 'Stored' : 'No stored data'), !isDirty && !!storedData);
    }

    function renderStored(){
      const previewEl = document.getElementById('preview');
      const subList = document.getElementById('substats-list');
      if(!storedData){
        if(previewEl) previewEl.textContent = '{ }';
        if(subList) subList.innerHTML = '<div style="color:#64748b">No stored data</div>';
        setStatus('No stored data');
        document.getElementById('total-hp').value = 0;
        document.getElementById('total-dmg').value = 0;
        const dpsEl = document.getElementById('dps'); if(dpsEl) dpsEl.value = 0;
        const hpReEl = document.getElementById('hp-regen'); if(hpReEl) hpReEl.value = 0;
        highlightDiffs();
        return;
      }
      // Use stored summary if present, otherwise compute and attach one
      let totals;
      if(storedData.summary){
        totals = storedData.summary;
      } else {
        totals = computeTotalsFromSlots(storedData.slots || []);
        storedData.summary = totals;
      }
      
      // Also compute current form totals for live comparison
      const currentTotals = getTotals().totals;
      
      if(previewEl) previewEl.textContent = JSON.stringify({summary:totals,slots:storedData.slots},null,2);
      if(subList) renderSubstats(totals.substats);
      
      // Helper to format comparison display: "current (±X%)"
      const formatComparison = (current, stored) => {
        current = current || 0;
        stored = stored || 0;
        if (stored === 0) {
          return current.toFixed(2); // can't calc %, just show current
        }
        const pct = ((current - stored) / stored) * 100;
        const pctStr = pct > 0 ? `+${pct.toFixed(1)}%` : `${pct.toFixed(1)}%`;
        return `${current.toFixed(2)} (${pctStr})`;
      };
      
      // Show all totals with live vs stored comparison
      document.getElementById('total-hp').value = formatComparison(currentTotals.totalHp, totals.totalHp);
      document.getElementById('total-dmg').value = formatComparison(currentTotals.totalDmg, totals.totalDmg);
      
      const dpsEl = document.getElementById('dps');
      if(dpsEl) dpsEl.value = formatComparison(currentTotals.dps, totals.dps);
      
      const hpReEl = document.getElementById('hp-regen');
      if(hpReEl) hpReEl.value = formatComparison(currentTotals.hpRegen, totals.hpRegen);
      
      markDirty(false);
      highlightDiffs();
    }

    function storeData(){
      storedData = readForm();
      // attach computed summary so renderStored can read derived values directly
      storedData.summary = computeTotalsFromSlots(storedData.slots);
      renderStored();
      // alert('Stored current form into JSON preview');  // I do not want this alert when pressing store!
    }

    function updatePreview(){
      // deprecated: preview only updates when stored
      // kept for backward compatibility
      const {d,totals} = getTotals();
      preview.textContent = JSON.stringify({summary:totals,slots:d.slots},null,2);
      totalHpInput.value = totals.totalHp || 0;
      totalDmgInput.value = totals.totalDmg || 0;
      const dpsEl = document.getElementById('dps'); if(dpsEl) dpsEl.value = (totals.dps !== undefined ? totals.dps.toFixed(2) : 0);
      const hpReEl = document.getElementById('hp-regen'); if(hpReEl) hpReEl.value = (totals.hpRegen !== undefined ? totals.hpRegen.toFixed(2) : 0);
      renderSubstats(totals.substats);
    }

    function computeSummary(){
      const {d,totals} = getTotals();
      preview.textContent = JSON.stringify({summary:totals,slots:d.slots},null,2);
      totalHpInput.value = totals.totalHp || 0;
      totalDmgInput.value = totals.totalDmg || 0;
      const dpsEl = document.getElementById('dps'); if(dpsEl) dpsEl.value = (totals.dps !== undefined ? totals.dps.toFixed(2) : 0);
      const hpReEl = document.getElementById('hp-regen'); if(hpReEl) hpReEl.value = (totals.hpRegen !== undefined ? totals.hpRegen.toFixed(2) : 0);
      renderSubstats(totals.substats);
    }

    function saveLocal(){
      if(!storedData){ alert('No stored JSON — press the Store button first'); return; }
      localStorage.setItem('dps_builder', JSON.stringify(storedData));
      alert('Saved stored JSON to localStorage');
    }

    function loadLocal(){
      const raw = localStorage.getItem('dps_builder');
      if(!raw){alert('No saved data');return}
      const obj = JSON.parse(raw);
      obj.slots.forEach((s,i)=>{
        const hpEl = document.querySelector(`[name="slot_${i}_hp"]`);
        const dmgEl = document.querySelector(`[name="slot_${i}_dmg"]`);
        if(hpEl) hpEl.value = (s.hp !== undefined && s.hp !== null) ? s.hp : '';
        if(dmgEl) dmgEl.value = (s.dmg !== undefined && s.dmg !== null) ? s.dmg : ''; 
        // enforce disabled/zero state for health-only or damage-only slots; mount, pets, and skill_bonus have both
        const slotName = SLOT_NAMES[i];
        if(HEALTH_ONLY.includes(slotName)){
          if(dmgEl){ dmgEl.value = 0; dmgEl.disabled = true; dmgEl.style.opacity = 0.6; }
          if(hpEl) hpEl.disabled = false;
        } else if(DAMAGE_ONLY.includes(slotName) && slotName !== 'mount' && !(slotName && slotName.startsWith && slotName.startsWith('pet')) && slotName !== 'skill_bonus'){
          if(hpEl){ hpEl.value = 0; hpEl.disabled = true; hpEl.style.opacity = 0.6; }
          if(dmgEl) dmgEl.disabled = false;
        } else {
          // slots with both inputs (including mount, pets, skill_bonus) — ensure both enabled
          if(hpEl) hpEl.disabled = false;
          if(dmgEl) dmgEl.disabled = false;
        }
        const sub1 = document.querySelector(`[name="slot_${i}_sub_1"]`); if(sub1) sub1.value = s.sub1;
        const sub1v = document.querySelector(`[name="slot_${i}_sub_1_val"]`); if(sub1v) sub1v.value = s.sub1v;
        const sub2 = document.querySelector(`[name="slot_${i}_sub_2"]`); if(sub2) sub2.value = s.sub2;
        const sub2v = document.querySelector(`[name="slot_${i}_sub_2_val"]`); if(sub2v) sub2v.value = s.sub2v;
      });
      // loaded into form; stored JSON is not changed until you press Store
      markDirty(true);      highlightDiffs();      alert('Loaded saved data into the form (press Store to update stored JSON)');
    }

    function exportJson(){
      if(!storedData){ alert('No stored JSON — press the Store button first'); return; }
      const blob = new Blob([JSON.stringify(storedData,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'dps_builder.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJson(e){
      const file = e.target.files && e.target.files[0];
      if(!file){ alert('No file selected'); return; }
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          if(!obj || !Array.isArray(obj.slots)){
            alert('Invalid JSON format: expected { slots: [...] }');
            return;
          }
          // Always populate slots from the imported JSON
          for(let i=0;i<SLOTS;i++){
            const s = obj.slots[i] || {hp:0,dmg:0,sub1:'none',sub1v:0,sub2:'none',sub2v:0};
            const hpEl = document.querySelector(`[name=\"slot_${i}_hp\"]`); if(hpEl) hpEl.value = (s.hp !== undefined && s.hp !== null) ? s.hp : '';
            const dmgEl = document.querySelector(`[name=\"slot_${i}_dmg\"]`); if(dmgEl) dmgEl.value = (s.dmg !== undefined && s.dmg !== null) ? s.dmg : ''; 
            const slotName = SLOT_NAMES[i];
            if(HEALTH_ONLY.includes(slotName)){
              // ensure damage is zeroed if present
              if(dmgEl){ dmgEl.value = 0; }
            } else if(DAMAGE_ONLY.includes(slotName) && slotName !== 'mount' && !(slotName && slotName.startsWith && slotName.startsWith('pet')) && slotName !== 'skill_bonus'){
              if(hpEl){ hpEl.value = 0; }
            } else {
              // mount, pets, skill_bonus, and other dual slots: keep both values as provided
            }
            const sub1 = document.querySelector(`[name="slot_${i}_sub_1"]`); if(sub1) sub1.value = s.sub1 || 'none';
            const sub1v = document.querySelector(`[name="slot_${i}_sub_1_val"]`); if(sub1v) sub1v.value = s.sub1v || 0;
            const sub2 = document.querySelector(`[name="slot_${i}_sub_2"]`); if(sub2) sub2.value = s.sub2 || 'none';
            const sub2v = document.querySelector(`[name="slot_${i}_sub_2_val"]`); if(sub2v) sub2v.value = s.sub2v || 0;
          }
          // If imported JSON already contains a computed summary, use it directly as stored data
          if(obj.summary){
            storedData = obj;
            renderStored();
            e.target.value = '';
            alert('Imported JSON loaded as stored snapshot (form also populated)');
          } else {
            // imported into form; press Store to update stored JSON
            markDirty(true);
            highlightDiffs();
            e.target.value = ''; // reset file input so re-importing same file works
            alert('Imported JSON into form (press Store to update stored JSON)');
          }
        }catch(err){
          alert('Error parsing JSON: '+err.message);
        }
      };
      reader.readAsText(file);
    }

    function resetForm(){
      if(!confirm('Reset all values to 0?')) return;
      for(let i=0;i<SLOTS;i++){
        const hpEl = document.querySelector(`[name="slot_${i}_hp"]`);
        const dmgEl = document.querySelector(`[name="slot_${i}_dmg"]`);
        if(hpEl) hpEl.value = '';
        if(dmgEl) dmgEl.value = '';
        const sub1 = document.querySelector(`[name="slot_${i}_sub_1"]`); if(sub1) sub1.value = 'none';
        const sub1v = document.querySelector(`[name="slot_${i}_sub_1_val"]`); if(sub1v) sub1v.value = 0;
        const sub2 = document.querySelector(`[name="slot_${i}_sub_2"]`); if(sub2) sub2.value = 'none';
        const sub2v = document.querySelector(`[name="slot_${i}_sub_2_val"]`); if(sub2v) sub2v.value = 0;
      }
      // preview (stored JSON) remains unchanged; mark form as dirty
      markDirty(true);
      highlightDiffs();
    }

    // init
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>